"use strict";const e=require("./config"),t=require("../shared/pv"),s=require("../shared/site_map"),i=require("../shared/chart_helpers");class a extends(mix(t).with(i)){constructor(){super(e),this.app="pageviews",this.entityInfo=!1,this.specialRange=null,this.initialQuery=!1,this.sort="views",this.direction="1",this.monthStart=this.initialMonthStart,this.monthEnd=this.maxMonth,window.articleSuggestionCallback=$.noop}initialize(){this.setupDateRangeSelector(),this.setupSelect2(),this.setupSelect2Colors(),this.popParams(),this.setupListeners(),this.updateInterAppLinks()}getLangviewsURL(e){return`/langviews?${$.param(this.getParams())}&page=${encodeURIComponent(e.score())}`}getRedirectviewsURL(e){return`/redirectviews?${$.param(this.getParams())}&page=${encodeURIComponent(e.score())}`}getSearchParams(e){return"autocomplete"===this.autocomplete?{action:"query",list:"prefixsearch",format:"json",pssearch:e||"",cirrusUseCompletionSuggester:"yes"}:"autocomplete_redirects"===this.autocomplete?{action:"query",generator:"prefixsearch",format:"json",gpssearch:e||"",gpslimit:"10",redirects:"true",cirrusUseCompletionSuggester:"no"}:void 0}popParams(){setTimeout(this.startSpinny.bind(this));let e=this.validateParams(this.parseQueryString("pages"));this.$projectInput.val(e.project),this.$platformSelector.val(e.platform),this.$agentSelector.val(e.agent),this.$redirectsCheckbox.prop("checked","true"===this.alwaysRedirects||"1"===e.redirects),this.validateDateRange(e),this.resetSelect2();const t=e=>{this.getPageAndEditInfo(e).then((e=>{this.initialQuery=!0;const t=Object.keys(e.entities);if(!t.length)return this.resetView(!1,!1);this.setSelect2Defaults(this.underscorePageNames(t))}))};e.pages&&e.pages.length?e.pages.length>10?this.massviewsRedirectWithPagePile(e.pages).then(t):(this.setInitialChartType(e.pages.length),t(e.pages)):this.getDefaultPages().done((e=>{this.setInitialChartType(e.length),t(e)})).fail((()=>{this.resetView(),this.setInitialChartType(),this.focusSelect2()}))}getDefaultPages(){const e=$.Deferred(),t=()=>{this.fetchSiteInfo(this.project).done((t=>{e.resolve([t[this.project].general.mainpage])})).fail(e.reject)};if("en.wikipedia"===this.project)e.resolve(["Cat","Dog"]);else if(this.project.includes("wikipedia")){const i="https://www.wikidata.org/w/api.php?action=wbgetentities&sites=enwiki&titles=Cat|Dog&props=sitelinks/urls|datatype&format=json&callback=?";$.getJSON(i).done((i=>{if(i.error)return e.resolve();const a=Object.keys(s).find((e=>s[e]===`${this.project}.org`)),r=Object.keys(i.entities).map((e=>i.entities[e].sitelinks[a]?i.entities[e].sitelinks[a].title:null)).filter(Boolean);if(!r.length)return t();e.resolve(r)}))}else t();return e}processSearchResults(e){const t=e?e.query:{};let s=[];return t?("autocomplete"===this.autocomplete?t.prefixsearch.length&&(s=t.prefixsearch.map((function(e){return{id:e.title.score(),text:e.title}}))):"autocomplete_redirects"===this.autocomplete&&(t.redirects&&(s=t.redirects.map((e=>({id:e.from.score(),text:e.from})))),Object.keys(t.pages).forEach((e=>{const i=t.pages[e];s.push({id:i.title.score(),text:i.title})}))),{results:s}):{results:s}}getParams(e=!0){let t={project:this.$projectInput.val(),platform:this.$platformSelector.val(),agent:this.$agentSelector.val(),redirects:this.includeRedirects()?"1":"0"};return this.specialRange&&e?t.range=this.specialRange.range:[t.start,t.end]=this.getDates(!0),this.noLogScale&&(t.autolog="false"),t}pushParams(){super.pushParams("pages")}setupSelect2(){let e={ajax:this.getArticleSelectorAjax(),tags:"no_autocomplete"===this.autocomplete,placeholder:$.i18n("article-placeholder"),maximumSelectionLength:10,minimumInputLength:1};super.setupSelect2(e),this.$select2Input.off("select2:open").on("select2:open",(e=>{$(e.target).val()&&10===$(e.target).val().length&&$(".select2-search__field").one("keyup",(()=>{const e=$.i18n("massviews-notice",10,`<strong><a href='/massviews/'>${$.i18n("massviews")}</a></strong>`);this.toastInfo(e)}))}))}getArticleSelectorAjax(){return"no_autocomplete"!==this.autocomplete?{url:`https://${this.project}.org/w/api.php`,dataType:"jsonp",delay:200,jsonpCallback:"articleSuggestionCallback",data:e=>this.getSearchParams(e.term),processResults:this.processSearchResults.bind(this),cache:!0}:null}resetView(e=!1,t=!0){super.resetView(e,t),this.$outputList.html(""),$(".single-entity-ranking").html(""),$(".single-page-stats").html(""),$(".single-page-legend").html("")}validateProject(){super.validateProject()&&(this.resetView(!0),this.focusSelect2())}setupListeners(){super.setupListeners(),this.$platformSelector.add(this.$agentSelector).add(this.$redirectsCheckbox).on("change",this.processInput.bind(this))}consolidateRedirectData(e,t){const s=Object.keys(e);if(!this.includeRedirects()||!s.length||!t.entities.length)return t;let i={entities:s,labels:t.labels,datasets:new Array(s.length),errors:t.errors,fatalErrors:t.fatalErrors,promises:t.promises};const a=this.getDateHeadings(!1),r=this.isMonthly()?"YYYY-MM":"YYYY-MM-DD";return Object.keys(e).forEach(((s,n)=>{e[s].map((e=>e.title)).forEach((e=>{const s=t.entities.indexOf(e);if(-1===s)return;t.datasets[s].map((t=>{const s=moment(t.timestamp,this.config.timestampFormat).format(r),o=a.indexOf(s),l=i.datasets[n]&&i.datasets[n][o]?i.datasets[n][o].views:0;t.article=e,t.views=t.views+l,i.datasets[n]=i.datasets[n]||new Array(a.length),i.datasets[n][o]=t}))}))})),i}processInput(e,t){const s=this.beforeProcessInput(e);if(!s)return;const i=e=>{this.getRedirects(e).done((t=>{Object.keys(t).forEach((s=>{e=e.concat(t[s].map((e=>e.title.score())))})),this.getPageViewsData(e.unique()).done((e=>{this.updateChart(this.consolidateRedirectData(t,e))}))}))};t?(this.removeEntity(t),this.getEditData(Object.keys(this.entityInfo.entities)).done((e=>{e.totals&&Object.assign(this.entityInfo.totals,e.totals),this.updateChart()}))):this.initialQuery?(i(s),this.initialQuery=!1):this.getPageAndEditInfo(s.map((e=>encodeURIComponent(e)))).then((()=>{i(s)}))}showSingleEntityLegend(){const e=this.outputData[0],t=this.getTopviewsMonth(!1),s=`${t.format("YYYY")}/${t.format("MM")}/all-days`;$.ajax({url:`https://wikimedia.org/api/rest_v1/metrics/pageviews/top/${this.project}/${this.$platformSelector.val()}/${s}`,dataType:"json"}).done((s=>{const i=s.items[0].articles.find((t=>t.article===e.label.score()));if(i){const e=this.daterangepicker.locale.monthNames[t.month()],s=`<a target='_blank' href='${this.getTopviewsMonthURL(this.project+".org",t)}'>`+$.i18n("most-viewed-pages").toLowerCase()+"</a>";$(".single-entity-ranking").html($.i18n("most-viewed-rank",i.rank,s,`${e} ${t.year()}`))}})).always((()=>{$(".table-view").hide(),$(".single-page-stats").html(`\n        ${this.getPageLink(e.label)}\n        ${e.assessment?"&middot;\n"+this.getAssessmentBadge(e):""}\n        &middot;\n        <span class='text-muted'>\n          ${this.$dateRangeSelector.val()}\n        </span>\n        &middot;\n        ${$.i18n("num-pageviews",this.formatNumber(e.sum),e.sum)}\n        <span class='hidden-lg'>\n          (${this.formatNumber(e.average)}/${$.i18n(this.isMonthly()?"month":"day")})\n        </span>\n      `),$(".single-page-legend").html(this.config.templates.chartLegend(this))}))}updateTable(){const e=this.beforeUpdateTable();if(!e)return;$.isNumeric(this.outputData[0].num_edits)||$(".legend-block--revisions .legend-block--body").html(`<span class='text-muted'>${$.i18n("data-unavailable")}</span>`);let t=!1,s=!1;e.forEach((e=>{e.protection!==$.i18n("none").toLowerCase()&&(t=!0),e.assessment&&e.assessment.length&&(s=!0),this.$outputList.append(this.config.templates.tableRow(this,e))}));const i=e.reduce(((e,t)=>e+t.sum),0),a=e.filter((e=>"none"!==e.protection)).length,r={label:$.i18n("num-pages",this.formatNumber(e.length),e.length),sum:i,average:Math.round(i/e[0].data.filter((e=>null!==e)).length),num_edits:this.entityInfo.totals?this.entityInfo.totals.num_edits:null,num_users:this.entityInfo.totals?this.entityInfo.totals.num_users:null,length:e.reduce(((e,t)=>e+t.length),0),protection:$.i18n("num-protections",this.formatNumber(a),a),watchers:e.reduce(((e,t)=>e+(t.watchers||0)),0)};this.$outputList.append(this.config.templates.tableRow(this,r,!0)),$(".table-view--protection").toggle(t),$(".table-view--class").toggle(s),$(".table-view").show()}getSortProperty(e,t){switch(t){case"title":return e.label;case"class":return e.assessment;case"views":return Number(e.sum);case"average":return Number(e.average);case"edits":return Number(e.num_edits);case"editors":return Number(e.num_users);case"size":return Number(e.length);case"watchers":return Number(e.watchers)}}getPageAndEditInfo(e){const t=$.Deferred();return this.getPageInfo(e).done((e=>{for(let t in e)e[t].missing&&!e[t].known&&(this.writeMessage(`${this.getPageLink(t)}: ${$.i18n("api-error-no-data")}`),delete e[t]);this.entityInfo={entities:e};const s=Object.keys(e);if(!s.length)return t.resolve(this.entityInfo);this.getEditData(s).done((e=>{s.forEach((t=>{let s=e.pages[t]||{},i=this.entityInfo.entities[t].protection||[];Array.isArray(i)&&(i=i.find((e=>"edit"===e.type))),s.protection=i?i.level:$.i18n("none").toLowerCase(),Object.assign(this.entityInfo.entities[t],s)})),this.entityInfo.totals=e.totals,t.resolve(this.entityInfo)})).fail((()=>{t.resolve(this.entityInfo)}))})).fail((()=>{t.resolve({})})),t}massviewsRedirectWithPagePile(e){const t=$.Deferred();return $.ajax({url:"https://pagepile.wmflabs.org/api.php",data:{action:"create_pile_with_data",wiki:this.dbName(this.project),data:e.join("\n")}}).success((e=>{const t=this.getParams();delete t.project,document.location=`/massviews?overflow=1&${$.param(t)}&source=pagepile&target=${e.pile.id}`})).fail((()=>{this.toastError($.i18n("auto-pagepile-error","PagePile",10)),t.resolve(e.slice(0,10))})),t}}$((()=>{new a}));
